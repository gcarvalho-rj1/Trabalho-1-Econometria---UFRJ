---
title: "Trabalho Econometria I"

author: "Mario Cesar (123674609), Guilherme (123671562) e Matheus (123443189)"

date: "18/11/2025"

output:

  html_document:

    highlight: textmate

    theme: flatly

    number_sections: yes

    includes:

      in_header: ufrj.html

    toc: yes

    toc_float:

      collapsed: yes

      smooth_scroll: no

  pdf_document:

    toc: yes
---
 
```{r pacotes, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(dplyr)
library(ggplot2)
library(stargazer)
library(lmtest)
library(sandwich)
library(car)
library(plotly)
```

```{r config_incial, include = FALSE}
dir_principal <- "C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1"
dir_code   <- file.path(dir_principal, "code")
dir_output <- file.path(dir_principal, "output")
dir_input  <- file.path(dir_principal, "input")
dir_tmp <- file.path(dir_principal, "tmp")

```

```{r dados_necessarios, include = FALSE}
load("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/input/base_inicial.RData")
load(file.path(dir_tmp, "regress_4.RData"))

```

# Trabalho de Econometria - Questão 1  
## Introdução
  Neste relatório apresentaremos a resolução da **Questão 1** do **Trabalho de Econometria**. Utilizamos os dados gerados a partir do script disponibilizado pelo professor, sendo baseados em uma simulação da equação de Mincer com erros homoscedásticos e heterocedásticos.  

## Estrutura da base de dados 
  A base de dados mostra uma simulação de um mercado de trabalho pela equação de Mincer. A equação de Mincer relaciona o salário com a escolaridade e experiência profissional. Os dados foram gerados incluindo heterogeneidade na escolaridade e com variáveis relevantes como sexo, raça e distribuição regional.  
  
  Além das variáveis explicativas (education, experience, male, white e dummies regionais), existem duas versões do salário: uma sob homoscedasticidade e outra sob heterocedasticidade. Dessa forma, investigaremos relaçoes entre variáveis através de regressões, testes para testar heterocedasticidade, estimaremos pelo método Feasible Generalized Least Squares (FGLS) e iremos comparar os resultados entre métodos.  

```{r data_inicial}
dplyr::glimpse(data)

```

## Estatísticas descritivas (Item 1.1) {.tabset}
  
### Principais
```{r descritivas, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "descritivas.html"))

```

### CV
```{r descritivas_2, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "descritivas_pt2.html"))
```
  
  
  
  Além das estatísticas básicas, julgamos produtivo incluir o coeficiente de variação (CV), pois o CV permite avaliar a variabilidade relativa de cada variável, comparando dispersões entre variáveis com escalas diferentes. Isso complementa a análise descritiva e ajuda a interpretar melhor a heterogeneidade presente na base simulada.  
  
  Observando as estatísticas, a escolaridade média é de 9,6 anos, com variabilidade moderada (CV = 0,330), o que sugere uma distribuição relativamente concentrada em torno da média. A proporção de homens (51,3%) e de indivíduos brancos (45,4%) coincide com os valores definidos no processo de simulação, e seus coeficientes de variação próximos de 1 refletem o comportamento esperado de variáveis binárias.  
  
  A experiência média é de aproximadamente 15 anos e apresenta maior dispersão relativa (CV = 0,613), o que é consistente com seu intervalo mais amplo. As dummies regionais mostram coeficientes de variação elevados, pois a categoria correspondente possui menor representatividade. 
  
  Os salários, tanto em nível quanto em log, apresentam padrões coerentes com a estrutura da equação de Mincer. O log-salário homocedástico possui baixa variabilidade (CV = 0,071), enquanto os salários em nível exibem maior dispersão, devido à transformação exponencial. Já o log-salário heterocedástico e seu correspondente em nível têm CVs maiores, refletindo a variância crescente introduzida no modelo heterocedástico. 


 
## Análise Gráfica do Salário x Educação
### Scatterplot: Salário × Educação (Item 1.2)
```{r sal-edu, echo = FALSE}
knitr::include_graphics("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/output/scatter_wage_homo_education_pred.png")
```

### Scatterplot: Log Salário × Educação (Item 1.2)
```{r logsal-edu, echo = FALSE}
knitr::include_graphics("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/output/scatter_log(wage_homo)_education_pred.png")
```


### Scatterplot: Log Salário × Experiência (Item 1.3)
```{r logsal-exp, echo = FALSE}
knitr::include_graphics("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/output/scatter_log(wage_homo)_experience_pred.png")
```
  
  
  
  Analisando os quatro gráficos concluímos que tanto a escolaridade quanto a experiência possuem relação positiva com os salários, mas essa relação se apresenta de maneira mais clara quando o salário é transformado em log. No primeiro gráfico, que relaciona salário em nível e escolaridade, observa-se um forte aumento da dispersão à medida que os anos de estudo crescem, indicando heterocedasticidade: indivíduos com a mesma escolaridade apresentam salários muito distintos, e essa variância cresce para níveis mais altos de educação.   
  Já nos gráficos que utilizam o log do salário, a relação tanto com experiência quanto com escolaridade torna-se mais linear e com dispersão mais homogênea. Desse modo, nós cremos que a transformação logarítmica reduz a heterocedasticidade dos dados. Além disso, percebe-se que a escolaridade apresenta uma relação mais crescente com o log do salário, enquanto a experiência também tem efeito positivo, porém com maior dispersão. Logo, os gráficos indicam que modelar o salário em log melhora a estabilidade da variância e mostra os retornos crescentes associados à educação e à experiência.

## Estimação da Equação de Mincer (OLS) utilizando log_wage_homo e log_wage_hetero
### Regressão Completa (Item 1.4) {.tabset}

#### Homoscedástico
```
data <- data %>% mutate(experience2 = experience^2)

# Região referência vai ser sudeste
# Gênero referência vai ser mulher
# Raça referência vai ser não branca

regress_4 <- lm(log_wage_homo ~ education + experience + experience2 + north + northeast + south + centerwest + male + white, data = data
)

```

#### Héterocedástico
```
# Cria a variável experience^2
data <- data %>% mutate(experience2 = experience^2)

# Região referência vai ser sudeste
# Gênero referência vai ser mulher
# Raça referência vai ser não branca
regress_4_hetero <- lm(log_wage_hetero ~ education + experience + experience2 + north + northeast + south + centerwest +
                       male + white, data = data
)
```
### Resultados da regressão {.tabset}

#### Homoscedástico
```{r tabela-ols, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "regress_4_tabela.html"))

```
  
  
  A regressão indica que escolaridade e experiência aumentam o salário, embora a experiência tenha retornos decrescentes. Todas as regiões fora a de referência exibem salários mais altos. Já homens e indivíduos brancos apresentam salários maiores na amostra. O modelo explica bem a variação do log do salário (R² ≈ 0,67), sugerindo que os determinantes incluídos capturam grande parte das diferenças salariais observadas. 
  
#### Heterocedástico
```{r tabela_hetero, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "regress_4_hetero_tabela.html"))

```
  
### Previsões e Gráfico 3D (Item 1.6) {.tabset}

#### Homoscedástico
```{r plot-3d, echo = FALSE}
load(file.path(dir_tmp, "regress_4.RData"))

# Carrega a base de dados
load(file.path(dir_input, "base_inicial.RData"))

# Criando os valores preditos
data$log_pred <- predict(regress_4)

plot_ly(data = data,
  x = ~education,
  y = ~experience,
  z = ~log_pred,
  type = "scatter3d",
  mode = "markers",
  marker = list(size = 3, color = ~log_pred, colorscale = "Viridis")
) %>%
  layout(
    scene = list(
      xaxis = list(title = "Educação (anos)"),
      yaxis = list(title = "Experiência"),
      zaxis = list(title = "Log do Salário (predito)")
    ),
    title = "Salário Predito em Função da Educação e Experiência"
  )
```
  
#### Heterocedástico
``` {r plot_3d_hetero, echo = FALSE}
# Carrega a regressão feita sobre as variáveis
load(file.path(dir_tmp, "regress_4_hetero.RData"))

# Carrega a base de dados
load(file.path(dir_input, "base_inicial.RData"))

# Criando os valores preditos
data$log_pred <- predict(regress_4_hetero)

plot_ly(data = data,
                     x = ~education,
                     y = ~experience,
                     z = ~log_pred,
                     type = "scatter3d",
                     mode = "markers",
                     marker = list(size = 3, color = ~log_pred, colorscale = "Viridis")
) %>%
  layout(
    scene = list(
      xaxis = list(title = "Educação (anos)"),
      yaxis = list(title = "Experiência"),
      zaxis = list(title = "Log do Salário (predito)")
    ),
    title = "Salário Predito em Função da Educação e Experiência"
  )
```

### Histograma dos resíduos (Item 1.6) {.tabset}

#### Homoscedástico
```{r hit_residuo_homo, echo = FALSE}
knitr::include_graphics("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/output/histograma_residuos.png")
``` 
  
  
  Os dois histogramas apresentam distribuições de resíduos aproximadamente simétricas e centradas em zero. Os dois histogramas indicam que os erros, tanto homocedástico quanto heterocedástico, possuem o formato próximo ao de uma distribuição normal.

A principal diferença dos gráficos está na amplitude e dispersão dos resíduos. No modelo homocedástico, os valores variam em torno de −1.2 a 1.1, enquanto no modelo heterocedástico essa faixa é maior, alcançando aproximadamente −2.2 a 2.1. Logo, ao permitir variância não constante, o modelo captura maior variabilidade nos erros.

Apesar dessa diferença na escala, a forma geral das distribuições permanece semelhante: ambas são simétricas, sem caudas exageradas ou assimetrias significativas. Dessa forma, conclui-se que a heterocedasticidade altera mais a magnitude dos resíduos do que sua estrutura ou comportamento central, influenciando a precisão dos erros-padrão e da inferência estatística.

#### Heterocedástico
```{r hit_residuo_hetero, echo = FALSE}
knitr::include_graphics("C:/Users/apdua/Desktop/Mario/Trabalho Econometria/Questão 1/output/histograma_residuos_hetero.png")
```
  
  
  
## Teste White para testar presença de heterocedasticidade na regressão da variáve log_wage_homo
```
teste_white_homo <- bptest(regress_4, ~ fitted(regress_4) + I(fitted(regress_4)^2))
```
```{r teste_white, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "teste_white_log_wage_homo.html"))
```
  
   
  Regressão com log_wage_homo:
  
  Não rejeitamos a hipótese nula de homocedasticidade. O comportamento dos resíduos é compatível com variância constante, como esperado, já que o salário foi gerado de forma homocedástica.
  

## Teste White para testar presença de heterocedasticidade na regressão da variáve log_wage_hetero
```
teste_white_hetero <- bptest(regress_4_hetero, ~ fitted(regress_4_hetero) + I(fitted(regress_4_hetero)^2))
```

```{r teste_white_hetero, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "teste_white_log_wage_hetero.html"))
```

  Regressão com log_wage_hetero:

  Rejeitamos fortemente a hipótese nula. Há evidências claras de heterocedasticidade, o que também era esperado, pois o salário nesta versão foi gerado com variância não constante.
  
## Estimação da equação minceriana por FGLS.
```
sigma2_chapeu <- residuals(regress_4_hetero)^2

# Regressão FGLS (weights = 1/sigma2_chapeu)
regress_fgls <- lm(log_wage_hetero ~ education + experience + I(experience^2) +
    male + white + north + northeast + south + centerwest, data = data, weights = 1/sigma2_chapeu
)
```

```{r fgls, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "resultado_FGLS.html"))

```

  A estimação por FGLS produziu coeficientes mais próximos dos valores verdadeiros utilizados na geração dos dados. Isso ocorre porque o FGLS corrige a heterocedasticidade presente no modelo com log_wage_hetero, ajustando os pesos de cada observação de acordo com a variância dos erros. Assim, as estimativas tornam-se mais eficientes e menos distorcidas do que as obtidas via OLS. Comparando os dois métodos, é possível observar que os coeficientes do FGLS não apenas mantêm os mesmos sinais e magnitudes gerais, mas também apresentam erros-padrão muito menores, refletindo maior precisão. Como a equação minceriana foi simulada com heterocedasticidade, esse resultado era esperado: o FGLS recupera melhor os parâmetros populacionais e fornece estimativas mais alinhadas com o modelo gerador dos dados.

## Diferença entre a equação minceriana estimada para o log_wage_hetero por OLS e FGLS para 200.000 e 2000 observações
```{r FGLS_x_OLS, echo = FALSE}
htmltools::includeHTML(file.path(dir_output, "OLS_x_FGLS_log_wage_hetero_200mil.html"))
htmltools::includeHTML(file.path(dir_output, "resultado_FGLS.html"))

```
  
  Quando aumentamos a amostra de 2000 para 200000 observações, a diferença das estimativas de OLS e FGLS ficam mais evidentes. Anteriormente quando analisamos para 2000 observações, o FGLS já mostrava coeficientes mais próximos dos valores verdadeiros da equação de Mincer. Porém com 200000 observações, o FGLS converge para valores praticamente iguais aos parâmetros populacionais, enquanto o OLS permanece enviesado em função da heterocedasticidade presente na variável dependente.

  Além disso, os erros-padrão no FGLS ficam extremamente pequenos, refletindo um enorme ganho de precisão, o que é visível quand comparamos colunas: enquanto no OLS os erros-padrão são cerca de 0,003 a 0,006, no FGLS eles passam a ser de 0,0002 a 0,001. O mesmo ocorre com a qualidade do ajuste: o R² do FGLS atinge 1, indicando que o modelo praticamente recupera a estrutura de geração dos dados, enquanto o OLS mantém um R² bem inferior (0,348), pois continua ignorando a forma verdadeira da variância dos erros.

  Logo, é possível concluir que aumentar a amostra mostra que o OLS não consegue recuperar os parâmetros corretos quando há heterocedasticidade relevante, enquanto o FGLS se torna ainda mais preciso e se aproxima dos valores reais usados na simulação.  


## Conclusão
  Nossa análise focou na equação de Mincer, usando dados criados artificialmente com erros de variância constante e variável. As estatísticas resumidas e os gráficos revelaram conexões notáveis entre salário, nível de escolaridade e tempo de experiência profissional, além de indícios visuais de que a variabilidade salarial não era uniforme. Testes estatísticos formais validaram essas tendências: o teste de White não encontrou heterocedasticidade no modelo de variância constante, mas identificou evidências significativas no modelo com variância variável, alinhando-se com a forma como os dados foram produzidos.

As estimativas enfatizaram o quão crucial é usar métodos apropriados para gerenciar a variabilidade não uniforme. O MQO gerou resultados aceitáveis no contexto de variância constante, mas exibiu imprecisões e erros padrão aumentados quando aplicado ao modelo com variância variável. Por outro lado, o MQGF resolveu essa restrição, recuperando parâmetros mais próximos dos valores reais e demonstrando maior exatidão. Ao expandir a amostra para duzentas mil observações, a vantagem do MQGF se tornou ainda mais clara, enquanto o MQO permaneceu impreciso.

Em resumo, os resultados enfatizam que a existência de heterocedasticidade afeta diretamente a eficácia e a credibilidade das estimativas, e que abordagens como o MQGF são essenciais quando a variância dos erros não é constante. O estudo também ilustrou como simulações podem ser valiosas para entender o desempenho dos estimadores sob diferentes condições.


 